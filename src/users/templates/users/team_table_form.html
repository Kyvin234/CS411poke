{% extends "pokewiki/base.html" %}
{% load static %}

{% load crispy_forms_tags %}
{% block content %}
    <div class="content-section">
        <form method="POST">
            {% csrf_token %}
            <fieldset class="form-group">
                <legend class="border-bottom mb-4">Team</legend>
                    <div class="form-row">
                        <div class="form-group col-md-6 mb-0">
                            {{ form.team_name|as_crispy_field }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-11 mb-0">
                            {{ form.description|as_crispy_field }}
                        </div>
                    </div>
                    <!-- add pokemon graph-->
                    <script src="//cdn.amcharts.com/lib/4/core.js"></script>
                    <script src="//cdn.amcharts.com/lib/4/charts.js"></script>
                    <script src="//cdn.amcharts.com/lib/4/themes/animated.js"></script>
                    <script src="//cdn.amcharts.com/lib/4/plugins/forceDirected.js"></script>
                    <div id="chartdiv">
                        <script>
                            am4core.useTheme(am4themes_animated);
                            // Create chart
                            var chart = am4core.create("chartdiv", am4plugins_forceDirected.ForceDirectedTree);
                            // Create series
                            var series = chart.series.push(new am4plugins_forceDirected.ForceDirectedSeries())
                            // Set data
                            series.data = [{
                              "name": "Tyranitar",
                              "value": 400,
                              "link":["Garchomp"]
                            }, {
                              "name": "Garchomp",
                              "value":400,
                              "link":["Pikachu"],
                              // "children": [{
                              //   "name": "B1", "value": 135
                              // },
                            }, {
                              "name": "Pikachu",
                              "value":400,
                              "link":["Garchomp","Tyranitar"],
                            }, {
                              "name": "Charizard",
                              "value":400,
                              "link":["Garchomp", "Pikachu"]
                            }, {
                              "name": "Blastoise",
                              "value":400,
                              "link":["Garchomp"],
                            }];
                            // Set up data fields
                            series.dataFields.value = "value";
                            series.dataFields.name = "name";
                            series.dataFields.children = "children";
                            series.dataFields.id = "name";
                            series.dataFields.linkWith = "link";
                            series.links.template.strokeWidth = 5;
                            // series.minRadius = 30;
                            // series.maxRadius = 30;
                            // Add labels
                            series.nodes.template.label.text = "{name}";
                            series.fontSize = 10;
                            series.minRadius = 15;
                            series.maxRadius = 40;
                            series.centerStrength = 0.5;
                            chart.zoomable = true;
                            series.nodes.template.events.on("hit", function(event) {
                              if (event.target.isActive) {
                                chart.zoomToDataItem(event.target.dataItem, 3, true)
                              }
                              else {
                                chart.zoomOut();
                              }
                            });
                        </script>
                    </div>
                    <div class="form-row" style="display:none">
                        <div class="form-group col-md-11 mb-0" >
                            {{ form.team_comp|as_crispy_field }}
                        </div>
                        <small class="text-muted">
                            <p>pick your Pokemon from below</p>
                        </small>
                    </div>
                    <ul id="myList" class="list-group">
                        <li id="1" class="list-group-item" onclick="select_edit(1)" ondblclick="delete_list(1)"></li>
                        <li id="2" class="list-group-item" onclick="select_edit(2)" ondblclick="delete_list(2)"></li>
                        <li id="3" class="list-group-item" onclick="select_edit(3)" ondblclick="delete_list(3)"></li>
                        <li id="4" class="list-group-item" onclick="select_edit(4)" ondblclick="delete_list(4)"></li>
                        <li id="5" class="list-group-item" onclick="select_edit(5)" ondblclick="delete_list(5)"></li>
                        <li id="6" class="list-group-item" onclick="select_edit(6)" ondblclick="delete_list(6)"></li>
                    </ul>
                    <div>
                        <small style="display: inline;"> STATUS: </small>
                        <small style="display: inline;" id="team_validation"></small>
                    </div>
                    
            </fieldset>
            <div class="form-group">
                <button class="btn btn-outline-info" type="submit">Create</button>
            </div>
            <div class = "searchbar mt-sm-2 mr-2">
                <input type = "text" class = "form-control" onkeyup = log_filter() id="myInput" placeholder = "Search for a Pokémon..."/>
            </div>
            <p id="pokemon_field">
                {%for l, k in pokemon_team_detail.items%}
                    {% for row in k%}
                        <img id='{{row.pokemon|lower}}' alt='{{row.dex_id}}' src="../../static/pokewiki/pokemon-icon/{{row.pokemon|lower}}.png" onclick="pokeSelect('{{row.pokemon|lower}}', '{{row.dex_id}}')" >
                        <!-- {{row}} -->
                    {%endfor%}
                {%endfor%}
            </p>

        </form>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
        //pokemon selector
        var select = 0;
        //a function to initialize team_dict for update
        //a function to delete the last added pokemon
        var team_dict = 
        {
                "p1": {"id" : 0, "name" : "", "nature" : "", "IV" : "", "EV" : "", "item" : ""},
                "p2": {"id" : 0, "name" : "", "nature" : "", "IV" : "", "EV" : "", "item" : ""},
                "p3": {"id" : 0, "name" : "", "nature" : "", "IV" : "", "EV" : "", "item" : ""},
                "p4": {"id" : 0, "name" : "", "nature" : "", "IV" : "", "EV" : "", "item" : ""},
                "p5": {"id" : 0, "name" : "", "nature" : "", "IV" : "", "EV" : "", "item" : ""},
                "p6": {"id" : 0, "name" : "", "nature" : "", "IV" : "", "EV" : "", "item" : ""},
        };
        var team_size = 0;
        //load the contents if updating
        window.onload = function()
        {
            //(using django to check if it's an updateview or a createview)
            {% if object %}
                //load from to-be-modified team
                var update = document.getElementById("id_team_comp");
                var obj = JSON.parse(update.value);
                for(let i = 1; i <= 6; i++)
                {
                    let list = document.getElementById(i.toString());
                    list.innerText = obj["p".concat(i.toString())]["name"];
                    team_dict["p".concat(i.toString())]["name"] = list.innerText;
                }
            {% endif %}

            //check if the team is valid
            valid_check();
        };
        
        /*
            Function to pick a pokemon from the field and append it to the team
        */
        function pokeSelect(pokename, dex_id)
        {
            if(select > 0)
            {
                //append name to the list
                var node = document.getElementById(select);
                if(node.innerText == "")
                    team_size++;
                node.innerText = pokename;
                //append the pokemon to dict
                team_dict["p".concat(select.toString())]["name"] = pokename;
                team_dict["p".concat(select.toString())]["id"]   = dex_id;
                //generate json data for the team
                var team_json = document.getElementById("id_team_comp");
                team_json.innerHTML = JSON.stringify(team_dict);
                // console.log(team_size);
                valid_check();
            }
        }
        /*
            highlight the list element being selected
        */
        function select_edit(select_id)
        {
            if(select != select_id)
            {
                select = select_id;
                for(let i = 1; i <= 6; i++)
                {
                    let list = document.getElementById(i);
                    if(i == select_id)
                        list.className = "list-group-item active";
                    else
                        list.className = "list-group-item";
                }

            }
        }
        /*
            Function to delete a pokemon from the list when double-clicked
        */
        function delete_list(select_id)
        {
            var list = document.getElementById(select_id);
            if(list.className == "list-group-item active")
            {
                list.className = "list-group-item"
                select = 0;
                list.innerText = "";
                team_size--;
                valid_check();
            }
        }
        /*
            Function to search a pokemon from the field 
        */
        function log_filter() 
        {
            var pokemons = document.getElementById("pokemon_field").children;
            var input, filter, i, txtValue;
            input = document.getElementById("myInput");
            filter = input.value.toUpperCase();
            for (i = 0; i < pokemons.length; i++) 
            {
                if (pokemons[i]) 
                {
                    txtValue = pokemons[i].id;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) 
                    {
                        pokemons[i].style.display = "";
                    } else 
                    {
                        pokemons[i].style.display = "none";
                    }
                }
            }
        }
        /*
            function to check if the team is valid
            -if it's valid, the status becomes green and the button is enabled to create a team
            -if it's invalid, the status becomes red and the button is disabled
        */
        function valid_check()
        {
            //get the team dictionary
            let team = document.getElementById("team_dict");
            let checker = document.getElementById("team_validation");
            //initial state
            if(team_size == 0)
            {
                return;
            }
            //check if there are 6 pokemons in the team 
            if(team_size != 6)
            {
                //invalid
                checker.innerText = "INVALID, You MUST have 6 pokemons in the team";
                checker.style.color = "#ff6b60"
                return;
            }
            //check based on the applied rule    
            gen7_ou_check();
            
        }
        /*
            team validator for gen7ou rule
        */
        function gen7_ou_check()
        {
            let checker = document.getElementById("team_validation");
            let array = []; //array for pokemon dex_id
            let mega_count = 0; //mega_count
            for(let key in team_dict)
            {
                array.push(team_dict[key]["id"]);
                
                if(team_dict[key]["name"].includes("-mega"))
                {
                    mega_count++;
                }
            }
            //check for pokemons with same national dex id
            if(hasDuplicates(array) == true)
            {
                checker.innerText   = "INVALID, You CANNOT have two Pokémons with the same National Pokédex number on a team.";
                checker.style.color = "#ff6b60"
            }
            else if(mega_count > 1) //check number of megas in the team
            {
                checker.innerText   = "INVALID, You CANNOT have more than one mega-evolved pokemons in one team.";
                checker.style.color = "#ff6b60"
            }
            else //valid
            {
                checker.innerText   = "VALID";
                checker.style.color = "#99ffcc";
            }
        }
        /*
            function to check if an array has a duplicate
        */
        function hasDuplicates(array) 
        {
            return (new Set(array)).size !== array.length;
        }
    </script>
{% endblock extra_js %}
