{% extends "pokewiki/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block title%}
    <script src="//cdn.amcharts.com/lib/4/core.js"></script>
    <script src="//cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="//cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <script src="//cdn.amcharts.com/lib/4/plugins/forceDirected.js"></script>
{% endblock %}
{% block content %}
    <div class="content-section">
        <form method="POST" id="team_form">
            {% csrf_token %}
            <fieldset class="form-group">
                <legend class="border-bottom mb-4">Team</legend>
                    <div class="form-row">
                        <div class="form-group col-md-6 mb-0">
                            {{ form.team_name|as_crispy_field }}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-11 mb-0">
                            {{ form.description|as_crispy_field }}
                        </div>
                    </div>
                    <div class="form-row" style="display:none">
                        <div class="form-group col-md-11 mb-0" >
                            {{ form.team_comp|as_crispy_field }}
                        </div>
                    </div>
                </fieldset>
        </form>

        <!-- rule constraints -->
        <div>
            <small style="display: inline;"> RULEs: </small>
            <br>
            <small style="display: inline;" id="rule1"> No more than ONE megas in the team</small>
            <br>
            <small style="display: inline;" id="rule2"> No two pokemons have two the same national dex number</small>
        </div>

        <!-- pokemon selecting field -->
        <!-- search bar -->
        <div class="input-group mb-3" >
            <div class="autocomplete" style="width:104.5vh">
                <input id="mySearch" type="text" name="myPokemon" placeholder="Search for PokÃ©mon..." class="form-control" aria-label="Small" aria-describedby="inputGroup-sizing-sm" onkeyup="team_filter()">
            </div>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="add_search_pokemon()">Add</button>
            </div>
        </div>

        <!-- add pokemon graph-->
        <div id="chartdiv">
            <script async>
                am4core.useTheme(am4themes_animated);

                // Create chart
                var chart = am4core.create("chartdiv", am4plugins_forceDirected.ForceDirectedTree);

                // Create series
                var series = chart.series.push(new am4plugins_forceDirected.ForceDirectedSeries());
                series.data = []

                // Initialize pokemon dictionary
                poke_dict = {}
                {%for l, k in pokemon_team_detail.items%}
                    {% for row in k%}
                        var poke_detail = JSON.parse("{{ row|escapejs }}");
                        poke_dict[poke_detail.pokemon] = poke_detail;
                    {%endfor%}
                {%endfor%}

                // Set up data fields
                series.dataFields.value = "value";
                series.dataFields.name = "name";
                series.dataFields.children = "children";
                series.dataFields.id = "name";
                series.dataFields.linkWith = "link";
                series.links.template.strokeWidth = 5;
                // series.minRadius = 30;
                // series.maxRadius = 30;
                series.dataFields.fixed = "fixed";
                series.nodes.template.propertyFields.x = "x";
                series.nodes.template.propertyFields.y = "y";

                // Add labels
                series.nodes.template.label.text = "{name}";
                series.fontSize = 8;
                series.minRadius = 15;
                series.maxRadius = 40;
                series.centerStrength = 0.5;

                //icons
                // series.nodes.template.circle.disabled = true;
                // series.nodes.template.outerCircle.disabled = true;
                var icon = series.nodes.template.createChild(am4core.Image);
                icon.propertyFields.href = "image";
                icon.horizontalCenter = "middle";
                icon.verticalCenter = "middle";
                icon.width = 40;
                icon.height = 40;
                chart.zoomable = true;
                series.nodes.template.events.on("hit", function(event) {
                    if (event.target.isActive) {
                    chart.zoomToDataItem(event.target.dataItem, 3, true)
                    }
                    else {
                    chart.zoomOut();
                    }
                });
            </script>
        </div>

        <!-- team member 1 -->
        <div class="square" id="1">
            <div class="team_picker">
                <div class="input-group input-group-sm mb-3">
                    <!-- pokemon name -->
                    <form method="POST">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-default">Pokemon</span>
                            </div>
                            <input readonly id="tm1" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                        </div>
                    </form>
                    <!-- pokemon ability -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Ability</label>
                        </div>
                        <select class="custom-select" id="as1" onchange="select_abi(this.value, 1)">
                            <option value="" disabled selected>Select Ability</option>
                        </select>
                    </div>
                    <!-- pokemon nature -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Nature</label>
                        </div>
                        <select class="custom-select" id="ns1" onchange="select_nat(this.value, 1)">
                            <option value="" disabled selected>Select Nature</option>
                        </select>
                    </div>
                    <!-- pokemon item -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Item</label>
                        </div>
                        <input readonly id="is1" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <!-- remove -->
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" onclick="remove_pokemon('p1')">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- team member 2 -->
        <div class="square" id="2">
            <div class="team_picker">
                <div class="input-group input-group-sm mb-3">
                    <!-- pokemon name -->
                    <form method="POST">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-default">Pokemon</span>
                            </div>
                            <input readonly id="tm2" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                        </div>
                    </form>
                    <!-- pokemon ability -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Ability</label>
                        </div>
                        <select class="custom-select" id="as2" onchange="select_abi(this.value, 2)">
                            <option value="" disabled selected>Select Ability</option>
                        </select>
                    </div>
                    <!-- pokemon nature -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Nature</label>
                        </div>
                        <select class="custom-select" id="ns2" onchange="select_nat(this.value, 2)">
                            <option value="" disabled selected>Select Nature</option>
                        </select>
                    </div>
                    <!-- pokemon item -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Item</label>
                        </div>
                        <input readonly id="is2" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <!-- remove -->
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" onclick="remove_pokemon('p2')">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- team member 3 -->
        <div class="square" id="3">
            <div class="team_picker">

                <div class="input-group input-group-sm mb-3">
                    <!-- pokemon name -->
                    <form method="POST">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-default">Pokemon</span>
                            </div>
                            <input readonly id="tm3" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                        </div>
                    </form>
                    <!-- pokemon ability -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Ability</label>
                        </div>
                        <select class="custom-select" id="as3" onchange="select_abi(this.value, 3)">
                            <option value="" disabled selected>Select Ability</option>
                        </select>
                    </div>
                    <!-- pokemon nature -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Nature</label>
                        </div>
                        <select class="custom-select" id="ns3" onchange="select_nat(this.value, 3)">
                            <option value="" disabled selected>Select Nature</option>
                        </select>
                    </div>
                    <!-- pokemon item -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Item</label>
                        </div>
                        <input readonly id="is3" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <!-- remove -->
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" onclick="remove_pokemon('p3')">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- team member 4 -->
        <div class="square" id="4">
            <div class="team_picker">
                <div class="input-group input-group-sm mb-3">
                    <!-- pokemon name -->
                    <form method="POST">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-default">Pokemon</span>
                            </div>
                            <input readonly id="tm4" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                        </div>
                    </form>
                    <!-- pokemon ability -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text" >Ability</label>
                        </div>
                        <select class="custom-select" id="as4" onchange="select_abi(this.value, 4)">
                            <option value="" disabled selected>Select Ability</option>
                        </select>
                    </div>
                    <!-- pokemon nature -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Nature</label>
                        </div>
                        <select class="custom-select" id="ns4" onchange="select_nat(this.value, 4)">
                            <option value="" disabled selected>Select Nature</option>
                        </select>
                    </div>
                    <!-- pokemon item -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Item</label>
                        </div>
                        <input readonly id="is4" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <!-- remove -->
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" onclick="remove_pokemon('p4')">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- team member 5 -->
        <div class="square" id="5">
            <div class="team_picker">
                <div class="input-group input-group-sm mb-3">
                    <!-- pokemon name -->
                    <form method="POST">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-default">Pokemon</span>
                            </div>
                            <input readonly id="tm5" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                        </div>
                    </form>
                    <!-- pokemon ability -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Ability</label>
                        </div>
                        <select class="custom-select" id="as5" onchange="select_abi(this.value, 5)">
                            <option value="" disabled selected>Select Ability</option>
                        </select>
                    </div>
                    <!-- pokemon nature -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Nature</label>
                        </div>
                        <select class="custom-select" id="ns5" onchange="select_nat(this.value, 5)">
                            <option value="" disabled selected>Select Nature</option>
                        </select>
                    </div>
                    <!-- pokemon item -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text">Item</label>
                        </div>
                        <input readonly id="is5" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <!-- remove -->
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" onclick="remove_pokemon('p5')">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- team member 6 -->
        <div class="square" id="6">
            <div class="team_picker">
                <div class="input-group input-group-sm mb-3">
                    <!-- pokemon name -->
                    <form method="POST">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="inputGroup-sizing-default">Pokemon</span>
                            </div>
                            <input readonly id="tm6" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                        </div>
                    </form>
                    <!-- pokemon ability -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Ability</label>
                        </div>
                        <select class="custom-select" id="as6" onchange="select_abi(this.value, 6)">
                            <option value="" disabled selected>Select Ability</option>
                        </select>
                    </div>
                    <!-- pokemon nature -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Nature</label>
                        </div>
                        <select class="custom-select" id="ns6" onchange="select_nat(this.value, 6)">
                            <option value="" disabled selected>Select Nature</option>
                        </select>
                    </div>
                    <!-- pokemon item -->
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <label class="input-group-text"  >Item</label>
                        </div>
                        <input readonly id="is6" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
                    </div>
                    <!-- remove -->
                    <div class="input-group mb-3">
                        <div class="input-group-append">
                            <button class="btn btn-outline-secondary" type="button" onclick="remove_pokemon('p6')">Remove</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <div id="pi_select" >
            <p id="item_field" >
                {% for entry in item_info%}
                    <td> <img id='{{entry.i_name}}'src="../../static/pokewiki/item-icon/{{entry.i_name}}.png" onclick="select_item(this.id)"loading=lazy></td>
                {% endfor %}
            </p>
        </div> -->
        <div class="form-group">
            <center><input type="submit" form="team_form"/></center>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <!-- User Interface in javascript -->
    <script async>
        //pokemon selector
        var select = 0;
        var cur_bar = 0; //0 pokemon filter, 1 item filter
        //active, valid, invalid colors for selected team member
        const inactive = "#e6eff3";
        const active   = "#9bd6f0";
        const valid    = "green";
        const invalid  = "red";
        //team json information
        var team_dict =
        {
                "p1": {"id" : 0, "name" : "", "nature" : "", "ability" : "", "IV" : "", "EV" : "", "item" : ""},
                "p2": {"id" : 0, "name" : "", "nature" : "", "ability" : "", "IV" : "", "EV" : "", "item" : ""},
                "p3": {"id" : 0, "name" : "", "nature" : "", "ability" : "", "IV" : "", "EV" : "", "item" : ""},
                "p4": {"id" : 0, "name" : "", "nature" : "", "ability" : "", "IV" : "", "EV" : "", "item" : ""},
                "p5": {"id" : 0, "name" : "", "nature" : "", "ability" : "", "IV" : "", "EV" : "", "item" : ""},
                "p6": {"id" : 0, "name" : "", "nature" : "", "ability" : "", "IV" : "", "EV" : "", "item" : ""},
        };
        /*
            load the contents if updating
        */
        window.onload = function()
        {
            //(using django to check if it's an updateview or a createview)
            {% if object %}
                //load from to-be-modified team
                team_dict = JSON.parse(document.getElementById("id_team_comp").value);
                let i, pn, an, nn;
                for(i = 1; i <= 6; i++)
                {
                    pn = team_dict["p".concat(i.toString())]["name"];
                    an  = team_dict["p".concat(i.toString())]["ability"];
                    nn  = team_dict["p".concat(i.toString())]["nature"];
                    get_pokeinfo(pokename, i);
                    nature_init(i);
                    document.getElementById("tm".concat(i.toString())).value = pn;
                    document.getElementById("as".concat(i.toString())).value = an;
                    document.getElementById("ns".concat(i.toString())).value = nn;
                }

            {% else %}
                for(i = 1; i <= 6; i++)
                    nature_init(i);
            {% endif %}
            //check if the team is valid
            valid_check();
            //hide item select field
            document.getElementById("item_field").style.display = "none";
        };
        /*
            Function to pick a pokemon from the field and append it to the team
        */
        /* function select_poke(pokename, dex_id)
        {
            if(select > 0)
            {
                clear_select(select);
                //append name to the list
                document.getElementById("tm".concat(select.toString())).value = pokename;
                //append the pokemon to dict
                team_dict["p".concat(select.toString())]["name"] = pokename;
                team_dict["p".concat(select.toString())]["id"]   = dex_id;
                //get pokemon detail
                get_pokeinfo(pokename, select);
                //check if the team is valid
                valid_check();
                //generate json data for the team
                document.getElementById("id_team_comp").innerHTML = JSON.stringify(team_dict);
            }
        } */
        /*
            Function to pick an item from the field and append it to the team
        */
        function select_item(itemname)
        {
            if(select > 0)
            {
                document.getElementById("is".concat(select.toString())).value = itemname;
                //append the item to dict
                team_dict["p".concat(select.toString())]["item"] = itemname;
                //generate json data for the team
                document.getElementById("id_team_comp").innerHTML = JSON.stringify(team_dict);
            }
        }
        /*
            highlight the list element being selected
        */
        function select_member(select_id)
        {
            if(select != select_id)
            {
                //deactivate previous selected
                if(select != 0)
                {
                    let tm = document.getElementById(select);
                    tm.style.backgroundColor = inactive;
                }
                //activate current selected
                select = select_id;
                tm = document.getElementById(select);
                tm.style.backgroundColor = active;

            }
        }

        /*
            Function to delete a pokemon from the list when double-clicked
        */
        function delete_member(select_id)
        {
            let mi = document.getElementById("tm".concat(select_id.toString())) //member input
            let tm = document.getElementById(select_id); //team_member
            if(select == select_id)
            {
                let di = "p".concat(select_id.toString());
                //set background to be unselected color
                tm.style.background = inactive;
                //clear the value
                mi.value = "";
                //set the team_dict
                team_dict[di]["name"]     = "";
                team_dict[di]["id"]       = "";
                team_dict[di]["nature"]   = "";
                team_dict[di]["ability"]  = "";
                //remove all options except the default first one
                clear_select(select_id);
                //reset select
                select = 0;
                //check if the team is valid
                valid_check();
            }
        }

        /*
            function to check if the team is valid
            -if it's valid, the status becomes green and the button is enabled to create a team
            -if it's invalid, the status becomes red and the button is disabled
        */
        function valid_check()
        {
            //check based on the applied rule
            gen7_ou_check();
        }
        /*
            team validator for gen7ou rule
        */
        function gen7_ou_check()
        {
            let array = []; //array for pokemon dex_id
            let mega_count = 0; //mega_count
            for(let key in team_dict)
            {
                if(team_dict[key]["id"] != "")
                    array.push(team_dict[key]["id"]);
                if(team_dict[key]["name"].includes("-mega"))
                {
                    mega_count++;
                }
            }
            //check number of megas in the team
            let checker = document.getElementById("rule1");
            if(mega_count > 1)
            {
                checker.style.color = invalid;
            }
            else{
                checker.style.color = valid;
            }
            //check for pokemons with same national dex id
            checker = document.getElementById("rule2");
            if(hasDuplicates(array) == true)
            {
                checker.style.color = invalid;
            }
            else{
                checker.style.color = valid;
            }
        }
        /*
            function to check if an array has a duplicate
        */
        function hasDuplicates(array)
        {
            return (new Set(array)).size !== array.length;
        }
        /*
            function that makes an ajax call to obtain pokemon details from backend
        */
        function get_pokeinfo(pokemon, select)
        {
            $.ajax({
                type:'POST',
                url: '/ajax/get_pokeinfo',
                data: {
                    'pokemon': pokemon,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function (data) {
                    //get info for a pokemon
                    // console.log(data["info"])
                    //append options to select
                    let i;
                    let l = data["ability"].length;
                    for(i = 0; i<l; i++)
                    {
                        optionText = data["ability"][i]["a_name"];
                        optionValue = data["ability"][i]["a_name"];
                        $('#as'.concat(select.toString())).append(`<option value="${optionValue}"> ${optionText} </option>`);
                    }
                },
                error: function(xhr){
                    alert("Error: " + xhr.statusText);
                    return false;
                }
            });
        }
        /*
            function that handles ability select
        */
        function select_abi(value, id)
        {
            team_dict["p".concat(id.toString())]["ability"] = value;
            // console.log(team_dict);
            //generate json data for the team
            document.getElementById("id_team_comp").innerHTML = JSON.stringify(team_dict);
        }
        /*
            function that handles nature select
        */
        function select_nat(value, id)
        {
            team_dict["p".concat(id.toString())]["nature"] = value;
            //generate json data for the team
            document.getElementById("id_team_comp").innerHTML = JSON.stringify(team_dict);
        }
        /*
            function that reset selected values and options
        */
        function clear_select(select_id)
        {
            var idx = select_id.toString();
            $('#as'.concat(idx)).find('option').not(':first').remove();
            $('#as'.concat(idx)).val("");
            $('#ns'.concat(idx)).val("");
            $('#is'.concat(idx)).val("");
        }
        /*
            function that initializes natures options
        */
        function nature_init(select_id)
        {
            $('#ns'.concat(select_id.toString())).append(`<option value="adamant"> Adamant Attack+ Sp.Atk- </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="bashful">  bashful</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="hardy"> hardy </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="lonely">  lonely</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="brave">  brave</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="naughty"> naughty </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="bold"> bold </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="docile">  docile</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="relaxed"> relaxed </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="impish"> impish </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="lax">  lax</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="timid">  timid</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="hasty"> hasty </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="serious">  serious</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="jolly"> jolly </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="naive"> naive </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="modest"> modest </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="mild">  mild</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="quiet">  quiet</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="rash">  rash</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="calm">  calm</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="gentle"> gentle </option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="sassysassy</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="careful">  careful</option>`);
            $('#ns'.concat(select_id.toString())).append(`<option value="quirky">  quirky</option>`);
        }
        /*
            toggle between pokemon picker and item picker
        */
        function pi_toggle()
        {
            var p,i,c;
            p = document.getElementById("pokemon_field");
            i = document.getElementById("item_field");
            if (p.style.display === "none") {
                //hide item picker and show pokemon picker
                p.style.display = "block";
                i.style.display = "none";
                cur_bar = 0;

            } else {
                //hide pokemon picker and show item picker
                p.style.display = "none";
                i.style.display = "block";
                cur_bar = 1;
                //finished toggling use p as a temp
                p = i;
            }
            //reset filter
            for(c = 0; c<p.children.length; c++)
            {
                p.children[c].style.display = "";
            }
            document.getElementById("search").value = "";
        }
    </script>
    <!-- script to handle autocomplete -->
    <script async >
    
    //push names, auto complete search select
    var poker = [];
    for(let p in poke_dict){
        poker.push(poke_dict[p].pokemon);
    }

    ottocomplete(document.getElementById("mySearch"), poker);
    function team_filter()
    {
            var input;
            //reset graph
            series.data = [];
            // Get typed string
            input = document.getElementById("mySearch").value.toLowerCase();
            //add the pokemon to the graph
            add_to_graph(input);
    }
    /*
        function that appends pokemon to the graph
    */
    function add_to_graph(input)
    {
        var data = [];
        if(poke_dict[input] === undefined)
        {
            return;
        }
        else
        {
            // if(p === input)
            // {
                var teammates = [];
                var moves = [];
                var abilities = [];
                var spreads = [];
                var items = [];
                for(let t in poke_dict[input].teammates)
                {
                    teammates.push({"image" : "../../static/pokewiki/pokemon-icon/".concat(t.toLowerCase()).concat(".png"), "value": parseInt(poke_dict[input].teammates[t].slice(1,2))});
                }
                for(let m in poke_dict[input].moves)
                {
                    moves.push({"name": m, "value":parseInt(poke_dict[input].moves[m].slice(1,2))});
                }
                for(let a in poke_dict[input].abilities)
                {
                    abilities.push({"name": a, "value":parseInt(poke_dict[input].abilities[a].slice(1,2))});
                }
                for(let s in poke_dict[input].spreads)
                {
                    spreads.push({"name": s, "value":poke_dict[input].spreads[s]});
                }
                for(let i in poke_dict[input].items)
                {
                    items.push({"name": i, "value":parseInt(poke_dict[input].items[i].slice(1,2))});
                }
                data.push({
                    "image": "../../static/pokewiki/pokemon-icon/".concat(poke_dict[input].pokemon).concat(".png"),
                    fixed: true,
                    x: am4core.percent(50),
                    y: am4core.percent(50),
                    "value": 20,
                    "link": teammates,
                    "children":
                    [
                        {
                            "name": "moves",
                            fixed: true,
                            x: am4core.percent(50),
                            y: am4core.percent(20), "value": 10,
                            "children": moves
                        },
                        {
                            "name": "abilities",
                            fixed: true,
                            x: am4core.percent(25),
                            y: am4core.percent(35),"value": 10,
                            "children": abilities
                        },
                        {
                            "name": "spreads",
                            fixed: true,
                            x: am4core.percent(75),
                            y: am4core.percent(35),"value": 10,
                            "children": spreads
                        },
                        {
                            "name": "items",
                            fixed: true,
                            x: am4core.percent(70),
                            y: am4core.percent(70),
                            "value": 10,
                            "children": items
                        },
                        {
                            "name": "teammates",
                            fixed: true,
                            x: am4core.percent(30),
                            y: am4core.percent(70),"value": 10,
                            "children": teammates
                        },
                    ]
                });
            // }
        }
        series.data = data;
        series.nodes.template.propertyFields.x = "x";
        series.nodes.template.propertyFields.y = "y";
    }

    /* Add searched pokemon to your team list */

    function add_search_pokemon(){
        var i, key;
        for(i = 1; i < 7; i++){
            key = "p" + i;
            if(team_dict[key].id === 0 && poke_dict[document.getElementById("mySearch").value.toLowerCase()] != undefined){
                pokemon_obj = poke_dict[document.getElementById("mySearch").value.toLowerCase()];
                //append name to the list
                document.getElementById("tm".concat(i.toString())).value = pokemon_obj.pokemon;
                //append the pokemon to dict
                team_dict[key]["name"] = pokemon_obj.pokemon;
                team_dict[key]["id"] = pokemon_obj.dex_id;
                //get pokemon detail
                get_pokeinfo(pokemon_obj.pokemon, i);
                //check if the team is valid
                valid_check();
                //generate json data for the team
                document.getElementById("id_team_comp").innerHTML = JSON.stringify(team_dict);
                break;
            }
        }
    }

    /* Remove pokemon from your team list */

    function remove_pokemon(index){
        team_dict[index] = {"id" : 0, "name" : "", "nature" : "", "ability" : "", "IV" : "", "EV" : "", "item" : ""};
        document.getElementById("tm".concat(index[1])).value = "";
        clear_select(index[1]);
        valid_check();
    }

    /*OTTO COMPLETE =============================================================*/

    function ottocomplete(inp, arr) {
     /* text field input element and an array of possible pokemon*/
      var currentFocus;

      inp.addEventListener("input", function(e) {
          var a, b, i, val = this.value;
          closeAllLists();
          if (!val) { return false;}
          currentFocus = -1;

          a = document.createElement("DIV");
          a.setAttribute("id", this.id + "autocomplete-list");
          a.setAttribute("class", "autocomplete-items");
          this.parentNode.appendChild(a);

          for (i = 0; i < arr.length; i++) {
            if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
              b = document.createElement("DIV");
              b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
              b.innerHTML += arr[i].substr(val.length);
              b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
              b.addEventListener("click", function(e) {
                  inp.value = this.getElementsByTagName("input")[0].value;
                  closeAllLists();
                  //filter the table and append
                  team_filter();
              });
              a.appendChild(b);
            }
          }
      });

      inp.addEventListener("keydown", function(e) {
          var x = document.getElementById(this.id + "autocomplete-list");
          if (x) x = x.getElementsByTagName("div");
          if (e.keyCode == 40) {
            /*DOWN*/
            currentFocus++;
            addActive(x);
          } else if (e.keyCode == 38) { //up
            /*UP*/
            currentFocus--;
            addActive(x);
          } else if (e.keyCode == 13) {
            e.preventDefault();
            if (currentFocus > -1) {
              if (x) x[currentFocus].click();
            }
          }
      });

      function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("autocomplete-active");
      }

      function removeActive(x) {
        for (var i = 0; i < x.length; i++) {
          x[i].classList.remove("autocomplete-active");
        }
      }

      function closeAllLists(elmnt) {
        var x = document.getElementsByClassName("autocomplete-items");
        for (var i = 0; i < x.length; i++) {
          if (elmnt != x[i] && elmnt != inp) {
            x[i].parentNode.removeChild(x[i]);
          }
        }
      }
      document.addEventListener("click", function (e) {
          closeAllLists(e.target);
      });
    }
    </script>
{% endblock extra_js %}
